# 用户要求

## 0. Panel 与 Eddy 概念绑定 ✅
**状态**: 已完成
**实现**: Panel 现在与 Eddy 对象建立一对一关系，支持编辑现有 Eddy 和创建新 Eddy 两种模式。

## 1. Panel 展开逻辑 ✅
**状态**: 已完成
**实现**: 
- 点击 floatingball，展开 panel：
  - 如果当前有 lastUsedEddy，那么默认展示这个 eddy ✅
  - 没有任何 eddy 的话，默认新建一个 eddy 并存储 ✅

## 2. Panel 标题显示 Eddy 名称 ✅
**状态**: 已完成
**实现**:
- Panel 左上方目前是"pageedit"字样，现在要修改成展示当前 eddy 的名字 ✅
- 名字在新建的时候就应该创建，叫做"new eddy" ✅
- 每个 eddy 应该有区分，就用 uuid 生成一个唯一 id 作为唯一标识 ✅
- 支持点击编辑 Eddy 名称 ✅
- 支持 Enter 确认、ESC 取消编辑 ✅

## 3. 工具栏增加新建 Eddy 按钮 ✅
**状态**: 已完成
**实现**:
- 上方的工具栏增加一个 + 号 ✅
- tooltip 内容为 "create new eddy" ✅
- 点击时保存当前 Eddy 并创建新 Eddy ✅
- 绿色主题色突出显示 ✅

## 4. Console 日志优化 ✅
**状态**: 已完成
**实现**:
- console 中打印 eddy 名字的时候，把 id 也打印出来 ✅
- 格式：`eddy.name (ID: eddy.id)` ✅
- 便于调试和跟踪 Eddy 状态 ✅

## 5. Eddy 下拉切换功能 ✅
**状态**: 已完成
**实现**:
- 左上的 eddy 名字，右边需要加一个下拉展开的按钮 ✅
- 点击可以展开当前所有的 eddy 项（展示名称） ✅
- 用户点击的话，可以切换当前编辑的 eddy 为所选 eddy ✅
- 显示 Eddy 名称和 ID（前8位） ✅
- 当前 Eddy 高亮显示 ✅
- 点击外部自动关闭 ✅

## 6. 下拉菜单定位修复 ✅
**状态**: 已完成
**问题**: 下拉菜单被 panel 的 overflow: hidden 截断，超出 panel 的部分看不见
**解决方案**:
- 将下拉菜单从 titleContainer 移动到 shadowRoot ✅
- 修改定位方式为 fixed，相对于视口定位 ✅
- 添加智能边界检测，自动调整位置 ✅
- 确保下拉菜单显示在所有页面上方 ✅

## 7. StorageService 优化 ✅
**状态**: 已完成
**优化内容**:
- 优化 `getLastUsedEddy` 方法的逻辑处理 ✅
- 先判断 eddys 数组是否为空，为空直接返回 null ✅
- 如果没有找到 lastUsed 为 true 的 Eddy，自动将最近更新的 Eddy 设置为 lastUsed ✅
- 增强错误恢复能力，避免数据不一致问题 ✅
- 更详细的日志记录，便于调试 ✅

## 8. Eddy 草稿功能 ✅
**状态**: 已完成
**实现**:
- 为 Eddy 添加 `draftContent` 字段用于保存草稿内容 ✅
- 实现自动草稿保存（1秒防抖延迟） ✅
- 应用修改时立即保存草稿 ✅
- 关闭面板时保存草稿 ✅
- 切换 Eddy 时自动加载对应的草稿内容 ✅
- 新建 Eddy 时清空输入框 ✅
- 临时 Eddy 不保存草稿 ✅
- 添加草稿保存的防抖机制，避免频繁保存 ✅

## 9. 临时 Eddy 自动转换与命名 ✅
**状态**: 已完成
**实现**: 
- 当在一个临时的、未保存的 Eddy 上首次应用修改时，系统会自动将其转换为一个永久的 Eddy。
- **自动命名**: 新创建的 Eddy 会自动使用用户输入的查询（最长 30 个字符）作为其名称。
- **历史迁移**: 临时 Eddy 的撤销/重做历史会一并迁移到新的永久 Eddy 中。

## 10. 临时 Eddy 自动命名
- **需求**: 当一个临时的 Eddy 在应用修改成功后被保存为永久 Eddy 时，它的名字也应该被更新。
- **方案**:
  - 在 `saveCurrentEddyToStorage` 方法中，检查 Eddy 是否为 `temp_` Eddy。
  - 如果是，则从 `StyleService` 的当前快照中获取用户查询。
  - 使用用户查询自动命名新的 Eddy（例如，截取前 30 个字符）。
  - 调用 `StorageService.createEddy` 时传入新名字。

---

# 方案

## 核心设计变更

### Panel 与 Eddy 绑定 ✅
**状态**: 已完成
将 Panel 从单纯的修改工具转变为 Eddy 管理工具，建立 Panel 与 Eddy 的一对一关系。

### Panel 展开逻辑 ✅
**状态**: 已完成
**当前逻辑**：点击悬浮球 → 展开空白面板 → 用户输入指令 → 应用修改
**新逻辑**：点击悬浮球 → 检查当前域名的 lastUsedEddy → 如果有则展示该 Eddy，如果没有则创建新的 "New Eddy"

**实现要点**：
- 在 `FloatingBall.handleClick()` 中调用 `StorageService.getLastUsedEddy()` ✅
- 如果有 lastUsedEddy，将 Panel 设置为编辑模式，显示该 Eddy 的信息 ✅
- 如果没有，创建新的 Eddy（名称为 "New Eddy" + UUID 后缀），设置为新建模式 ✅

### Panel 标题动态显示 ✅
**状态**: 已完成
**当前**：固定显示 "PageEdit"
**新设计**：动态显示当前 Eddy 的名称

**实现要点**：
- Panel 标题需要支持动态更新 ✅
- 新建 Eddy 时，名称格式：`"New Eddy"` 或 `"New Eddy (uuid前8位)"` ✅
- 编辑现有 Eddy 时，显示实际名称 ✅
- 需要添加 Eddy 名称编辑功能 ✅

### 工具栏 "+" 按钮 ✅
**状态**: 已完成
**功能**：创建新的 Eddy
**位置**：在现有的 Undo、Theme、Close 按钮旁边
**Tooltip**：显示 "CREATE NEW EDDY"

**实现要点**：
- 点击 "+" 按钮时，保存当前 Eddy（如果有修改） ✅
- 创建新的 Eddy，名称为 "New Eddy" + UUID ✅
- 清空面板内容，准备新的编辑 ✅

### Eddy 草稿系统 ✅
**状态**: 已完成
**功能**：自动保存和恢复用户的输入内容
**实现要点**：
- 在 Eddy 类型中添加 `draftContent` 字段 ✅
- 实现防抖机制，避免频繁保存 ✅
- 在关键操作时自动保存草稿（输入、应用、关闭、切换） ✅
- 切换 Eddy 时自动加载对应的草稿内容 ✅
- 新建 Eddy 时清空输入框 ✅

## 技术实现考虑

### 数据结构变更 ✅
```typescript
// 当前 Panel 状态
interface PanelState {
  currentEddy: Eddy | null;
  isNewEddy: boolean;
  hasUnsavedChanges: boolean;
}

// Eddy 类型扩展
interface Eddy {
  // ... 现有字段
  draftContent?: string; // 新增草稿内容字段
}
```

### Panel 生命周期 ✅
1. **初始化**：检查 lastUsedEddy ✅
2. **编辑模式**：显示现有 Eddy 内容和草稿 ✅
3. **新建模式**：创建新 Eddy，显示空白界面 ✅
4. **保存**：应用修改并保存 Eddy ✅
5. **切换**：通过 "+" 按钮切换到新 Eddy ✅
6. **草稿管理**：自动保存和加载草稿内容 ✅

### 用户体验流程 ✅
```
点击悬浮球
    ↓
检查 lastUsedEddy
    ↓
有 Eddy? → 显示现有 Eddy 内容和草稿
    ↓
无 Eddy? → 创建 "New Eddy" 并显示空白界面
    ↓
用户输入修改指令 → 自动保存草稿
    ↓
应用修改（实时） → 立即保存草稿
    ↓
用户点击 "+" → 保存当前 Eddy 和草稿，创建新 Eddy
    ↓
用户点击下拉按钮 → 显示所有 Eddy 列表
    ↓
用户选择 Eddy → 保存当前草稿，切换到选中的 Eddy，加载对应草稿
```

## 潜在问题和考虑

### 1. 自动保存 vs 手动保存 ✅
- **自动保存**：每次修改后自动保存 Eddy
- **手动保存**：用户需要主动保存
- **建议**：采用自动保存，避免数据丢失
- **实现**: 采用自动保存策略，在关键操作时自动保存

### 2. Eddy 命名策略 ✅
- **简单命名**：`"New Eddy"`、`"New Eddy (2)"`、`"New Eddy (3)"`
- **UUID 命名**：`"New Eddy (a1b2c3d4)"`
- **时间命名**：`"New Eddy (2024-01-15 14:30)"`
- **建议**：使用简单递增命名，UUID 作为内部标识
- **实现**: 使用简单命名 "New Eddy"，UUID 作为内部标识

### 3. 未保存修改的处理 ✅
- 用户切换到新 Eddy 时，如何处理当前未保存的修改？
- **建议**：自动保存当前修改，然后创建新 Eddy
- **实现**: 在创建新 Eddy 前自动保存当前修改

### 4. Eddy 切换时的状态管理 ✅
- 如何保持不同 Eddy 的修改历史？
- 如何管理多个 Eddy 之间的切换？
- **实现**: 通过 StorageService 管理 Eddy 状态，支持切换时保存

### 5. 草稿内容管理 ✅
- 如何避免草稿内容过大影响性能？
- 如何处理草稿内容的版本控制？
- **建议**：设置草稿内容大小限制，定期清理过期草稿
- **实现**: 使用防抖机制减少保存频率，草稿内容与 Eddy 绑定

## 界面设计建议

### Panel 标题区域 ✅
```
[Eddy名称] [编辑按钮] [Undo] [Theme] [+] [Close]
```

### Eddy 名称编辑 ✅
- 点击 Eddy 名称可以编辑 ✅
- 支持回车确认，ESC 取消 ✅
- 实时验证名称唯一性 ✅

### 状态指示 🔄
- 显示当前 Eddy 的修改数量
- 显示最后保存时间
- 显示是否有未保存修改

## 总结

✅ **已完成**: 这个方案将 Panel 从简单的修改工具升级为完整的 Eddy 管理系统，提供了更好的用户体验和数据管理能力。核心是建立 Panel 与 Eddy 的一对一关系，让用户能够方便地创建、编辑和管理多个样式预设。

### 🎯 下一步计划
1. **功能测试** - 在浏览器中测试所有新功能
2. **Eddy 修改内容保存** - 实现修改内容的持久化
3. **Eddy 列表管理** - 添加 Eddy 列表查看和管理功能
4. **状态指示优化** - 添加修改数量、保存时间等状态显示
5. **草稿功能优化** - 添加草稿内容大小限制和清理机制 